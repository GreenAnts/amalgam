<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>HSK 3.0 Chinese Vocabulary Game</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --reseda-green: #797d62ff;
            --moss-green: #9b9b7aff;
            --desert-sand: #d9ae94ff;
            --peach-yellow: #f1dca7ff;
            --sunglow: #ffcb69ff;
            --persian-orange: #d08c60ff;
            --beaver: #997b66ff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, var(--reseda-green), var(--moss-green));
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            cursor: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><circle cx="10" cy="10" r="8" fill="rgba(241,220,167,0.8)" stroke="rgba(121,125,98,0.8)" stroke-width="2"/></svg>') 10 10, auto;
        }

        .click-effect {
            position: fixed;
            width: 40px;
            height: 40px;
            pointer-events: none;
            z-index: 9999;
            animation: clickFade 0.66s ease-out forwards;
        }

        @keyframes clickFade {
            0% { opacity: 1; transform: scale(0.5); }
            50% { opacity: 0.8; transform: scale(1.2); }
            100% { opacity: 0; transform: scale(1); }
        }

        .landing-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            color: white;
            text-align: center;
            padding: 20px;
        }

        .landing-page h1 {
            font-size: 3rem;
            margin-bottom: 2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            color: var(--peach-yellow);
        }

        .selection-container {
            background: rgba(255,255,255,0.15);
            padding: 0;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(31,38,135,0.37);
            border: 1px solid rgba(255,255,255,0.18);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .config-section {
            padding: 25px 30px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .config-section:last-child {
            border-bottom: none;
        }

        .config-section h3 {
            font-size: 1.3rem;
            color: var(--peach-yellow);
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }

        .config-section.band-section {
            background: linear-gradient(45deg, rgba(255,203,105,0.1), rgba(208,140,96,0.1));
        }

        .config-section.range-section {
            background: linear-gradient(45deg, rgba(217,174,148,0.1), rgba(241,220,167,0.1));
        }

        .config-section.options-section {
            background: linear-gradient(45deg, rgba(155,155,122,0.1), rgba(121,125,98,0.1));
        }

        .config-section.controls-section {
            background: linear-gradient(45deg, rgba(153,123,102,0.1), rgba(121,125,98,0.1));
        }

        .slider-container {
            margin: 0;
        }

        .slider-container label {
            display: block;
            margin-bottom: 10px;
            font-size: 1rem;
            color: white;
        }

        .range-input-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
            justify-content: center;
            flex-wrap: wrap;
        }

        .range-input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .range-input-group label {
            font-size: 0.9rem;
            color: var(--peach-yellow);
            margin-bottom: 0;
        }

        .range-input {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 1rem;
            color: white;
            text-align: center;
            width: 80px;
            transition: all 0.3s ease;
        }

        .range-input:focus {
            outline: none;
            border-color: var(--sunglow);
            background: rgba(255,255,255,0.3);
        }

        .range-input::placeholder {
            color: rgba(255,255,255,0.7);
        }

        .range-separator {
            font-size: 1.2rem;
            color: var(--peach-yellow);
            font-weight: bold;
        }

        .range-values {
            margin: 10px 0;
            font-size: 1.1rem;
            color: var(--sunglow);
        }

        .range-progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            margin: 15px 0;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .range-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--sunglow), var(--persian-orange));
            border-radius: 10px;
            transition: all 0.3s ease;
            position: relative;
        }

        .range-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
            z-index: 2;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }

        .checkbox-container label {
            font-size: 1rem;
            color: white;
            cursor: pointer;
        }

        .tier-dropdown {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 1rem;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .tier-dropdown:focus {
            outline: none;
            border-color: var(--sunglow);
        }

        .tier-dropdown option {
            background: var(--beaver);
            color: white;
        }

        .game-options-grid {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            width: 100%;
        }

        .option-divider {
            width: 2px;
            height: 60px;
            background: linear-gradient(180deg, transparent, rgba(255,255,255,0.3), transparent);
            border-radius: 2px;
        }

        .tier-select {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .tier-select label {
            font-size: 1rem;
            color: white;
        }

        .custom-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            background: rgba(255,255,255,0.2);
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
        }

        .custom-checkbox.checked {
            background: var(--sunglow);
            border-color: var(--sunglow);
        }

        .custom-checkbox.checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .start-button {
            background: linear-gradient(45deg, var(--persian-orange), var(--beaver));
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 12px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .start-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            background: linear-gradient(45deg, var(--sunglow), var(--persian-orange));
        }

        .game-page {
            display: none;
            height: 100vh;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .score-bar {
            background: linear-gradient(90deg, var(--reseda-green), var(--beaver));
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 1.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .menu-controls {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .mobile-menu-toggle {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            display: none;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .stars-counter {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1.8rem;
            color: var(--sunglow);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .mobile-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 10px;
            right: 10px;
            background: rgba(0,0,0,0.95);
            border-radius: 10px;
            padding: 15px;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }

        .mobile-menu.active {
            display: block;
        }

        .mobile-menu-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .mobile-menu-row {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .menu-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .menu-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        .menu-btn.exit {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            border: 1px solid rgba(255,107,107,0.8);
        }

        .menu-btn.exit:hover {
            background: linear-gradient(45deg, #ff5252, #d32f2f);
        }

        .audio-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
            min-width: 150px;
        }

        .volume-container {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
        }

        .volume-slider {
            flex: 1;
            height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: var(--sunglow);
            border-radius: 50%;
            cursor: pointer;
        }

        .volume-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: var(--sunglow);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .volume-label {
            font-size: 0.7rem;
            color: white;
            min-width: 20px;
            text-align: center;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        .info-icon {
            width: 16px;
            height: 16px;
            background: var(--peach-yellow);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: var(--beaver);
            cursor: help;
            position: relative;
        }

        .info-tooltip {
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 1001;
        }

        .info-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid rgba(0,0,0,0.9);
        }

        .info-icon:hover .info-tooltip {
            opacity: 1;
            visibility: visible;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 25px;
            background: rgba(255,255,255,0.3);
            border-radius: 25px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: var(--sunglow);
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 21px;
            height: 21px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(25px);
        }

        .toggle-label {
            font-size: 0.8rem;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, var(--reseda-green), var(--moss-green));
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            color: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h2 {
            margin-bottom: 20px;
            text-align: center;
            color: var(--peach-yellow);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .settings-section {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
        }

        .settings-section h3 {
            color: var(--peach-yellow);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .hotkey-setting {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            padding: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .hotkey-input {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            padding: 6px 10px;
            border-radius: 6px;
            color: white;
            width: 80px;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .hotkey-input:focus {
            border-color: var(--sunglow);
            background: rgba(255,255,255,0.3);
            outline: none;
        }

        .hotkey-input.listening {
            border-color: var(--persian-orange);
            background: rgba(255, 152, 0, 0.2);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .close-btn {
            background: linear-gradient(45deg, var(--persian-orange), var(--beaver));
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            margin: 20px auto 0;
            display: block;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .star-icon {
            color: var(--sunglow);
            font-size: 1.8rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .mascot-icon {
            position: fixed;
            width: 150px;
            height: 150px;
            opacity: 1;
            visibility: visible;
            transition: all 0.3s ease;
            z-index: 100;
            pointer-events: none;
        }

        .mascot-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        #mascotImage {
            position: relative;
            top: -50px;
            left: 215px;
            width: 200px;
            height: 200px;
        }

        .characters-row {
            height: 240px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(90deg, rgba(217,174,148,0.3), rgba(241,220,167,0.3));
            padding: 30px 0;
            border-bottom: 4px solid transparent;
            border-image: linear-gradient(90deg, var(--desert-sand), var(--peach-yellow), var(--desert-sand)) 1;
            box-shadow: 
                inset 0 -3px 6px rgba(0,0,0,0.1),
                0 2px 8px rgba(0,0,0,0.15);
        }

        .character-container {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(145deg, rgba(255,255,255,0.95), rgba(241,220,167,0.9));
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            transition: all 0.5s ease;
            min-width: 120px;
            max-width: 200px;
            height: 150px;
            border: 3px solid transparent;
            padding: 10px;
            box-sizing: border-box;
        }

        .character-container.active {
            border-color: var(--sunglow);
            transform: scale(1.3);
            z-index: 10;
            box-shadow: 0 12px 30px rgba(255, 203, 105, 0.4);
            left: 50% !important;
            transform: translateX(-50%) scale(1.3);
            background: linear-gradient(145deg, rgba(255,203,105,0.9), rgba(241,220,167,0.95));
        }

        .character-container.next {
            transform: scale(1.0);
            opacity: 0.9;
            z-index: 5;
            border-color: var(--desert-sand);
        }

        .character-container.upcoming {
            transform: scale(0.8);
            opacity: 0.7;
            z-index: 1;
            border-color: rgba(155,155,122,0.5);
        }

        .pinyin {
            font-size: 0.9rem;
            color: var(--beaver);
            margin-bottom: 5px;
            text-align: center;
            word-wrap: break-word;
            font-weight: 500;
            transition: opacity 0.3s ease;
        }

        .pinyin.hidden {
            opacity: 0;
            height: 0;
            margin: 0;
        }

        .chinese-char {
            font-size: 2rem;
            font-weight: bold;
            color: var(--reseda-green);
            text-align: center;
            word-wrap: break-word;
            line-height: 1.2;
        }

        .character-container.active .chinese-char {
            font-size: 2.5rem;
            color: var(--beaver);
        }

        .options-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(180deg, rgba(155,155,122,0.1), rgba(121,125,98,0.1));
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 15px;
            width: min(80vw, 800px);
            height: min(65vh, 520px);
        }

        .option-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: none;
            border-radius: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            padding: 20px 15px;
            min-height: 100px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .option-btn span {
            font-size: clamp(0.8rem, 2vw, 1.2rem);
            text-align: center;
            line-height: 1.2;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            max-width: 100%;
        }

        .option-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.25);
        }

        .tier-bronze {
            background: linear-gradient(145deg, var(--beaver), var(--reseda-green));
            border: 3px solid var(--moss-green);
        }

        .tier-silver {
            background: linear-gradient(145deg, var(--moss-green), var(--desert-sand));
            border: 3px solid var(--peach-yellow);
        }

        .tier-gold {
            background: linear-gradient(145deg, var(--sunglow), var(--persian-orange));
            border: 3px solid var(--sunglow);
            animation: goldGlow 2s ease-in-out infinite alternate;
        }

        @keyframes goldGlow {
            from { box-shadow: 0 6px 20px rgba(255, 203, 105, 0.4); }
            to { box-shadow: 0 8px 30px rgba(255, 203, 105, 0.6); }
        }

        .progress-bar {
            position: absolute;
            bottom: 5px;
            left: 10px;
            right: 10px;
            height: 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--sunglow), var(--persian-orange));
            border-radius: 6px;
            transition: width 0.3s ease;
            position: relative;
        }

        .progress-count {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .hotkey {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.7);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            z-index: 10;
        }

        @keyframes correct {
            0% { transform: scale(1); }
            25% { transform: scale(1.1); background: var(--sunglow); box-shadow: 0 0 20px var(--sunglow); }
            50% { transform: scale(1.2) rotate(5deg); }
            75% { transform: scale(1.1) rotate(-5deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        @keyframes shake {
            0% { transform: translateX(0) rotate(0deg); }
            10% { transform: translateX(-8px) rotate(-3deg); }
            20% { transform: translateX(8px) rotate(3deg); }
            30% { transform: translateX(-6px) rotate(-2deg); }
            40% { transform: translateX(6px) rotate(2deg); }
            50% { transform: translateX(-4px) rotate(-1deg); }
            60% { transform: translateX(4px) rotate(1deg); }
            70% { transform: translateX(-2px) rotate(-0.5deg); }
            80% { transform: translateX(2px) rotate(0.5deg); }
            90% { transform: translateX(-1px) rotate(-0.25deg); }
            100% { transform: translateX(0) rotate(0deg); }
        }

        @keyframes slideLeft {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(-200px); opacity: 0; }
        }

        @keyframes floatUp {
            from { 
                transform: translateY(0) scale(1); 
                opacity: 1; 
            }
            to { 
                transform: translateY(-50px) scale(1.2); 
                opacity: 0; 
            }
        }

        @keyframes newWordEntry {
            0% { 
                transform: scale(0) rotateY(90deg); 
                opacity: 0; 
            }
            50% { 
                transform: scale(1.1) rotateY(0deg); 
                opacity: 1; 
            }
            100% { 
                transform: scale(1) rotateY(0deg); 
                opacity: 1; 
            }
        }

        @keyframes tierUp {
            0% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.2) rotate(10deg); box-shadow: 0 0 30px currentColor; }
            100% { transform: scale(1) rotate(0deg); }
        }

        @keyframes starShoot {
            0% { 
                transform: scale(0) rotate(0deg); 
                opacity: 0; 
                color: var(--sunglow);
            }
            30% { 
                transform: scale(1.5) rotate(180deg); 
                opacity: 1; 
                color: var(--sunglow);
                text-shadow: 0 0 20px var(--sunglow);
            }
            70% { 
                transform: scale(2) rotate(360deg) translateY(-30px); 
                opacity: 1; 
                color: var(--persian-orange);
                text-shadow: 0 0 30px var(--sunglow);
            }
            100% { 
                transform: scale(1) rotate(540deg) translateY(0px); 
                opacity: 1; 
                color: var(--sunglow);
            }
        }

        .correct-animation { animation: correct 0.8s ease; }
        .shake-animation { animation: shake 0.8s ease; }
        .slide-left { animation: slideLeft 0.5s ease; }
        .float-up { animation: floatUp 1s ease; }
        .new-word-entry { animation: newWordEntry 0.8s ease; }
        .tier-up { animation: tierUp 0.8s ease; }
        .star-shoot { animation: starShoot 1.2s ease; }

        @media (max-width: 768px) {
            .score-bar {
                font-size: 1.2rem;
                padding: 10px;
            }

            .menu-controls { display: none; }
            .mobile-menu-toggle { display: block; }
            
            .stars-counter { font-size: 1.5rem; }
            .star-icon { font-size: 1.3rem; }

            .characters-row {
                height: 200px;
                padding: 15px 10px;
            }

            .mascot-icon {
                right: 10px;
                height: 70%;
            }

            .character-container {
                min-width: 90px;
                max-width: 130px;
                height: 110px;
                padding: 8px;
            }

            .character-container.active {
                transform: translateX(-50%) scale(1.1);
                z-index: 100;
            }

            .character-container.next {
                transform: scale(0.8);
                opacity: 0.8;
                z-index: 5;
            }

            .character-container.upcoming {
                transform: scale(0.6);
                opacity: 0.6;
                z-index: 1;
            }

            .pinyin { font-size: 0.8rem; }
            .chinese-char { font-size: 1.5rem; }
            .character-container.active .chinese-char { font-size: 1.8rem; }

            .options-grid {
                width: 95vw;
                height: 420px;
                gap: 12px;
                grid-template-rows: repeat(4, minmax(95px, 1fr));
            }
            
            .option-btn {
                font-size: 0.85rem;
                padding: 12px 8px;
                min-height: 95px;
                max-height: 110px;
            }

            .option-btn span {
                font-size: clamp(0.75rem, 1.8vw, 1rem);
                line-height: 1.1;
            }
            
            .landing-page {
                padding: 10px;
                min-height: 100vh;
            }

            .landing-page h1 {
                font-size: 2rem;
                margin-bottom: 1.5rem;
            }

            .selection-container {
                padding: 20px;
                margin-bottom: 15px;
                width: 100%;
                max-width: 90vw;
            }

            .range-input-container { gap: 10px; }
            .range-input { width: 70px; padding: 6px 8px; font-size: 0.9rem; }
            .slider-container { margin: 15px 0; }
            .slider-container label { font-size: 1rem; margin-bottom: 8px; }
            .range-values { font-size: 1rem; }
            .tier-select { margin: 15px 0; }
            .tier-select label { font-size: 1rem; }
            .tier-dropdown { padding: 6px 10px; font-size: 0.9rem; width: 100%; max-width: 200px; }

            .start-button {
                padding: 12px 25px;
                font-size: 1rem;
                margin: 8px;
                width: calc(100% - 16px);
                max-width: 300px;
            }

            .modal-content {
                width: 95%;
                max-width: none;
                margin: 5% auto;
                padding: 20px;
            }

            .hotkey-setting {
                margin: 8px 0;
                padding: 6px;
                font-size: 0.8rem;
            }

            .hotkey-input {
                width: 60px;
                padding: 4px 6px;
                font-size: 0.7rem;
            }

            .toggle-container {
                flex-direction: column;
                gap: 4px;
                align-items: center;
            }

            .toggle-label { font-size: 0.7rem; }
            .toggle-switch { width: 40px; height: 20px; }
            .toggle-slider { width: 16px; height: 16px; top: 2px; left: 2px; }
            .toggle-switch.active .toggle-slider { transform: translateX(20px); }
            .mascot-icon { width: 110px; height: 110px; }
            .hotkey { width: 18px; height: 18px; font-size: 0.6rem; top: 3px; right: 3px; }
            .mobile-menu-row { gap: 8px; }
            .audio-controls { min-width: 120px; }
            .volume-container { flex-direction: column; gap: 4px; }
        }
    </style>
</head>
<body>
    <div class="landing-page" id="landingPage">
        <h1>HSK 3.0 Chinese Vocabulary</h1>
        <div class="selection-container">
            <div class="config-section band-section">
                <h3>📚 Select HSK Band</h3>
                <div class="slider-container">
                    <select class="tier-dropdown" id="bandSelector" onchange="changeBand()">
                        <option value="1" selected>Band 1</option>
                        <option value="2">Band 2</option>
                        <option value="3">Band 3</option>
                    </select>
                </div>
            </div>

            <div class="config-section range-section">
                <h3>🎯 Select Word Range</h3>
                <div class="slider-container">
                    <div class="range-input-container">
                        <div class="range-input-group">
                            <label>From:</label>
                            <input type="number" id="startInput" class="range-input" min="1" max="50" value="1" onchange="updateRange()" oninput="updateRange()">
                        </div>
                        <span class="range-separator">—</span>
                        <div class="range-input-group">
                            <label>To:</label>
                            <input type="number" id="endInput" class="range-input" min="1" max="50" value="50" onchange="updateRange()" oninput="updateRange()">
                        </div>
                    </div>
                    <div class="range-values">
                        Words: <span id="startValue">1</span> - <span id="endValue">50</span>
                        (<span id="totalWords">50</span> total)
                    </div>
                    <div class="range-progress-bar">
                        <div class="range-progress-fill" id="rangeProgressFill"></div>
                        <div class="range-progress-text" id="rangeProgressText">50 / 500 words</div>
                    </div>
                </div>
            </div>

            <div class="config-section options-section">
                <h3>⚙️ Game Options</h3>
                <div class="game-options-grid">
                    <div class="option-item">
                        <div class="checkbox-container">
                            <div class="custom-checkbox" id="randomizeCheckbox" onclick="toggleRandomize()"></div>
                            <label for="randomizeCheckbox" onclick="toggleRandomize()">Randomize word order</label>
                        </div>
                    </div>
                    
                    <div class="option-divider"></div>
                    
                    <div class="option-item">
                        <div class="tier-select">
                            <label>Correct answers per tier:</label>
                            <select class="tier-dropdown" id="landingTierRequirement">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3" selected>3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                                <option value="13">13</option>
                                <option value="14">14</option>
                                <option value="15">15</option>
                                <option value="16">16</option>
                                <option value="17">17</option>
                                <option value="18">18</option>
                                <option value="19">19</option>
                                <option value="20">20</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="config-section controls-section">
                <h3>🚀 Start Game</h3>
                <button class="start-button" onclick="startGame(false)">Custom Selection</button>
                <button class="start-button" onclick="startGame(true)" id="allWordsButton">All Words in Band</button>
            </div>
        </div>
    </div>

    <div class="game-page" id="gamePage">
        <div class="score-bar">
            <div class="menu-controls">
                <button class="menu-btn exit" onclick="returnToMenu()">← Menu</button>
                <button class="menu-btn" onclick="openSettings()">⚙️ Settings</button>
            </div>

            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">☰</button>

            <div class="stars-counter">
                <span class="star-icon" id="starIcon">⭐</span>
                <span id="starsCount">0</span> / <span id="totalStarsCount">0</span>
            </div>

            <div class="mobile-menu" id="mobileMenu">
                <div class="mobile-menu-content">
                    <div class="mobile-menu-row">
                        <button class="menu-btn exit" onclick="returnToMenu()">← Menu</button>
                        <button class="menu-btn" onclick="openSettings()">⚙️ Settings</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="characters-row" id="charactersRow">
            <div class="mascot-container" id="mascotContainer">
                <img id="mascotImage" src="Mascot/walk.gif" alt="Mascot" />
            </div>
        </div>
        
        <div class="options-container">
            <div class="options-grid" id="optionsGrid"></div>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h2>⚙️ Game Settings</h2>
            <div class="settings-grid">
                
                <div class="settings-section">
                    <h3>🔊 Audio Settings</h3>
                    <div class="toggle-container">
                        <span class="toggle-label">Background Music</span>
                        <div class="toggle-switch" id="musicToggle" onclick="toggleMusic()">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="audio-controls">
                        <div class="volume-container">
                            <span class="volume-label">🎵</span>
                            <input type="range" id="musicVolume" class="volume-slider" min="0" max="100" value="30" onchange="adjustMusicVolume()">
                            <span class="volume-label" id="musicVolumeText">30%</span>
                        </div>
                    </div>
                    
                    <div class="toggle-container">
                        <span class="toggle-label">Sound Effects</span>
                        <div class="toggle-switch active" id="sfxToggle" onclick="toggleSFX()">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="audio-controls">
                        <div class="volume-container">
                            <span class="volume-label">🔊</span>
                            <input type="range" id="sfxVolume" class="volume-slider" min="0" max="100" value="70" onchange="adjustSFXVolume()">
                            <span class="volume-label" id="sfxVolumeText">70%</span>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>🎮 Display Settings</h3>
                    <div class="toggle-container">
                        <span class="toggle-label">Easy Mode</span>
                        <div class="toggle-switch" id="easyModeToggleSettings" onclick="toggleEasyMode()">
                            <div class="toggle-slider"></div>
                        </div>
                        <div class="info-icon">
                            i
                            <div class="info-tooltip">Prevents losing tiers on wrong answers</div>
                        </div>
                    </div>
                    
                    <div class="toggle-container">
                        <span class="toggle-label">Traditional Characters</span>
                        <div class="toggle-switch" id="traditionalToggleSettings" onclick="toggleTraditional()">
                            <div class="toggle-slider"></div>
                        </div>
                        <div class="info-icon">
                            i
                            <div class="info-tooltip">Simplified vs Traditional characters</div>
                        </div>
                    </div>
                    
                    <div class="toggle-container">
                        <span class="toggle-label">Show Pinyin</span>
                        <div class="toggle-switch active" id="pinyinToggle" onclick="togglePinyin()">
                            <div class="toggle-slider"></div>
                        </div>
                        <div class="info-icon">
                            i
                            <div class="info-tooltip">Show/hide pronunciation guide</div>
                        </div>
                    </div>
                    
                    <div class="toggle-container" id="pinyinModeContainer">
                        <span class="toggle-label">Pinyin Practice Mode</span>
                        <div class="toggle-switch" id="pinyinModeToggle" onclick="togglePinyinMode()">
                            <div class="toggle-slider"></div>
                        </div>
                        <div class="info-icon">
                            i
                            <div class="info-tooltip">Replace English with Pinyin on buttons</div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>⌨️ Hotkey Settings</h3>
                    <div id="hotkeySettings"></div>
                </div>

            </div>
            <button class="close-btn" onclick="closeSettings()">Save & Close</button>
        </div>
    </div>

    <audio id="backgroundMusic" loop preload="auto">
        <source src="Audio/background.ogg" type="audio/ogg">
        <source src="Audio/background.mp3" type="audio/mp3">
    </audio>

    <script src="wordlists/band-1-words.js"></script>
    <script src="wordlists/band-2-words.js"></script>
    <script src="wordlists/band-3-words.js"></script>

    <script>
        let gameSettings = {
            music: { enabled: false, volume: 0.3 },
            sfx: { enabled: true, volume: 0.7 },
            ui: { showPinyin: true, pinyinMode: false, easyMode: false, traditional: false },
            mascot: { lastInteraction: Date.now(), idleTimeout: 5000 }
        };

        const hskBands = {
            1: typeof hskBand1 !== 'undefined' ? hskBand1 : [],
            2: typeof hskBand2 !== 'undefined' ? hskBand2 : [],
            3: typeof hskBand3 !== 'undefined' ? hskBand3 : []
        };

        let hskWords = [];
        let currentBand = 1;
        let useTraditional = false;
        let randomizeWords = false;

        let gameState = {
            selectedWords: [], currentWords: [], activeWordIndex: 0, wordProgress: {},
            starsEarned: 0, completedWords: 0, charactersOnScreen: [], optionButtons: [],
            currentOptions: [], hotkeys: ['7', '8', '9', '4', '5', '6', '1', '2', '3', '0'],
            streakCount: 0, lastAnswerTime: 0, alreadyPenalized: false, easyMode: false,
            tierRequirement: 5,
            mascotAnimations: {
                idle: 'Mascot/idle.gif', walk: 'Mascot/walk.gif', rally: 'Mascot/rally.gif',
                sad: 'Mascot/sad.gif', celebrate: 'Mascot/celebrate.gif', ouch: 'Mascot/ouch.gif'
            },
            mascotAnimationDurations: {
                idle: 1200, walk: 800, rally: 1000, sad: 5400, celebrate: 1100, ouch: 650
            },
            mascotAnimationQueue: [], currentMascotAnimation: 'walk',
            mascotAnimationPlaying: false, sadAnimationActive: false,
            shakeInProgress: false, pendingCharacterAdvance: false
        };

        function loadHSKWords(band = 1) {
            try {
                if (hskBands[band] && hskBands[band].length > 0) {
                    hskWords = hskBands[band];
                    console.log(`Loaded ${hskWords.length} words from HSK Band ${band}`);
                    
                    const allWordsButton = document.getElementById('allWordsButton');
                    if (allWordsButton) {
                        allWordsButton.textContent = `All Words (Band ${band})`;
                    }
                    
                    const maxWords = hskWords.length;
                    document.getElementById('startInput').max = maxWords;
                    document.getElementById('endInput').max = maxWords;
                    document.getElementById('endInput').value = Math.min(50, maxWords);
                    updateRange();
                    
                    return true;
                } else {
                    throw new Error(`Band ${band} not available or empty`);
                }
            } catch (error) {
                console.error('Failed to load HSK words:', error);
                hskWords = hskBands[1] || [];
                console.log('Using fallback wordlist');
                return false;
            }
        }

        function getChineseChar(word) {
            return useTraditional && word.traditional ? word.traditional : word.chinese;
        }

        function playPronunciation(text) {
            if (!text) return;
            
            try {
                const audio = new Audio();
                const ttsUrl = `https://translate.google.com/translate_tts?tl=zh-CN&q=${encodeURIComponent(text)}&client=tw-ob`;
                
                audio.src = ttsUrl;
                audio.volume = gameSettings.sfx.volume;
                
                if (gameSettings.sfx.enabled) {
                    audio.play().catch(err => {
                        console.log('TTS failed silently:', err);
                    });
                }
            } catch (error) {
                console.log('TTS creation failed:', error);
            }
        }

        function initializeBackgroundMusic() {
            const bgMusic = document.getElementById('backgroundMusic');
            if (bgMusic) {
                bgMusic.volume = gameSettings.music.volume;
                bgMusic.muted = !gameSettings.music.enabled;
            }
        }

        function toggleMusic() {
            gameSettings.music.enabled = !gameSettings.music.enabled;
            const toggle = document.getElementById('musicToggle');
            const bgMusic = document.getElementById('backgroundMusic');
            
            if (gameSettings.music.enabled) {
                toggle.classList.add('active');
                if (bgMusic) {
                    bgMusic.muted = false;
                    bgMusic.play().catch(e => console.log('Music play failed:', e));
                }
            } else {
                toggle.classList.remove('active');
                if (bgMusic) {
                    bgMusic.muted = true;
                    bgMusic.pause();
                }
            }
        }

        function adjustMusicVolume() {
            const slider = document.getElementById('musicVolume');
            const label = document.getElementById('musicVolumeText');
            const bgMusic = document.getElementById('backgroundMusic');
            
            gameSettings.music.volume = slider.value / 100;
            label.textContent = `${slider.value}%`;
            
            if (bgMusic) {
                bgMusic.volume = gameSettings.music.volume;
            }
        }

        function toggleSFX() {
            gameSettings.sfx.enabled = !gameSettings.sfx.enabled;
            const toggle = document.getElementById('sfxToggle');
            
            if (gameSettings.sfx.enabled) {
                toggle.classList.add('active');
                playClickSound();
            } else {
                toggle.classList.remove('active');
            }
        }

        function adjustSFXVolume() {
            const slider = document.getElementById('sfxVolume');
            const label = document.getElementById('sfxVolumeText');
            
            gameSettings.sfx.volume = slider.value / 100;
            label.textContent = `${slider.value}%`;
        }

        function playSound(type) {
            if (!gameSettings.sfx.enabled) return;
            
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                let frequencies, duration;
                
                switch(type) {
                    case 'correct':
                        frequencies = [523, 659, 784];
                        duration = 0.3;
                        break;
                    case 'incorrect':
                        frequencies = [196, 220];
                        duration = 0.5;
                        break;
                    case 'complete':
                        frequencies = [523, 659, 784, 1047];
                        duration = 0.8;
                        break;
                    case 'tierUp':
                        frequencies = [440, 554, 659];
                        duration = 0.6;
                        break;
                    case 'starShoot':
                        frequencies = [523, 659, 784, 1047, 1319];
                        duration = 1.0;
                        break;
                    case 'click':
                        frequencies = [800, 1000];
                        duration = 0.1;
                        break;
                    default:
                        frequencies = [440];
                        duration = 0.3;
                }
                
                frequencies.forEach((frequency, index) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = frequency;
                    oscillator.type = type === 'incorrect' ? 'sawtooth' : 'sine';
                    
                    const startTime = audioContext.currentTime + (index * 0.05);
                    const volume = gameSettings.sfx.volume * (type === 'click' ? 0.3 : 0.4);
                    gainNode.gain.setValueAtTime(volume, startTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
                    
                    oscillator.start(startTime);
                    oscillator.stop(startTime + duration);
                });
            } catch (error) {
                console.log('Sound synthesis failed:', error);
            }
        }

        function playClickSound() {
            playSound('click');
        }

        function createClickEffect(event) {
            if (!gameSettings.sfx.enabled) return;
            
            const effect = document.createElement('img');
            effect.className = 'click-effect';
            effect.src = 'Sprites/click.gif?t=' + Date.now();
            effect.style.left = (event.clientX - 20) + 'px';
            effect.style.top = (event.clientY - 20) + 'px';
            
            document.body.appendChild(effect);
            
            playClickSound();
            
            setTimeout(() => {
                if (effect.parentNode) {
                    effect.parentNode.removeChild(effect);
                }
            }, 660);
        }

        document.addEventListener('click', createClickEffect);

        function setupIdleDetection() {
            document.addEventListener('click', () => {
                gameSettings.mascot.lastInteraction = Date.now();
                if (gameState.currentMascotAnimation === 'idle') {
                    queueMascotAnimation('walk');
                }
            });

            document.addEventListener('keydown', () => {
                gameSettings.mascot.lastInteraction = Date.now();
                if (gameState.currentMascotAnimation === 'idle') {
                    queueMascotAnimation('walk');
                }
            });

            setInterval(checkIdleState, 1000);
        }

        function checkIdleState() {
            const timeSinceLastInteraction = Date.now() - gameSettings.mascot.lastInteraction;
            
            if (timeSinceLastInteraction > gameSettings.mascot.idleTimeout && 
                gameState.currentMascotAnimation === 'walk' && 
                !gameState.mascotAnimationPlaying &&
                gameState.mascotAnimationQueue.length === 0) {
                
                queueMascotAnimation('idle');
            }
        }

        function setMascotAnimation(animationType) {
            const mascotImage = document.getElementById('mascotImage');
            if (mascotImage && gameState.mascotAnimations[animationType]) {
                const timestamp = new Date().getTime();
                mascotImage.src = gameState.mascotAnimations[animationType] + '?t=' + timestamp;
                gameState.currentMascotAnimation = animationType;
                
                if (animationType === 'sad') {
                    gameState.sadAnimationActive = true;
                }
            }
        }

        function queueMascotAnimation(animationType) {
            if (animationType === 'walk' || animationType === 'idle') {
                if (!gameState.mascotAnimationPlaying && gameState.mascotAnimationQueue.length === 0 && !gameState.sadAnimationActive) {
                    setMascotAnimation(animationType);
                }
                return;
            }

            if (gameState.sadAnimationActive) {
                console.log(`Blocking ${animationType} animation because sad animation is active`);
                return;
            }

            gameState.mascotAnimationQueue.push(animationType);
            processAnimationQueue();
        }

        function processAnimationQueue() {
            if (gameState.mascotAnimationPlaying || gameState.mascotAnimationQueue.length === 0) return;

            const nextAnimation = gameState.mascotAnimationQueue.shift();
            gameState.mascotAnimationPlaying = true;
            
            setMascotAnimation(nextAnimation);
            
            const duration = gameState.mascotAnimationDurations[nextAnimation] || 1000;
            setTimeout(() => {
                gameState.mascotAnimationPlaying = false;
                
                if (nextAnimation === 'sad') {
                    gameState.sadAnimationActive = false;
                }
                
                if (['rally', 'celebrate', 'ouch'].includes(nextAnimation)) {
                    setMascotAnimation('walk');
                    gameSettings.mascot.lastInteraction = Date.now();
                }
                
                processAnimationQueue();
            }, duration);
        }
        
        function togglePinyinMode() {
            gameSettings.ui.pinyinMode = !gameSettings.ui.pinyinMode;
            const toggle = document.getElementById('pinyinModeToggle');
            
            if (gameSettings.ui.pinyinMode) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
            
            updateOptionButtonsText();
        }

        function updatePinyinDisplay() {
            const pinyinElements = document.querySelectorAll('.pinyin');
            pinyinElements.forEach(element => {
                if (gameSettings.ui.showPinyin) {
                    element.classList.remove('hidden');
                } else {
                    element.classList.add('hidden');
                }
            });
        }

        function updateOptionButtonsText() {
            gameState.optionButtons.forEach((button, index) => {
                const word = gameState.currentOptions[index];
                if (word) {
                    const span = button.querySelector('span');
                    if (span) {
                        span.textContent = gameSettings.ui.pinyinMode ? word.pinyin : word.english;
                    }
                }
            });
        }
        
        // FIXED: Shake Animation System with proper timing
        function highlightCorrectAnswer(correctWord) {
            if (gameState.shakeInProgress) {
                console.log('Shake already in progress, skipping...');
                return;
            }

            gameState.shakeInProgress = true;
            
            const activeCharacter = gameState.charactersOnScreen[gameState.activeWordIndex];
            if (!activeCharacter) {
                gameState.shakeInProgress = false;
                return;
            }
            
            const activeWordChinese = activeCharacter.word.chinese;
            
            gameState.optionButtons.forEach((button, index) => {
                const option = gameState.currentOptions[index];
                if (option && option.chinese === activeWordChinese) {
                    button.classList.add('shake-animation');
                    button.style.border = '3px solid var(--sunglow)';
                    button.style.boxShadow = '0 0 15px rgba(255, 203, 105, 0.6)';
                    
                    // Clear shake after animation completes
                    setTimeout(() => {
                        button.classList.remove('shake-animation');
                        button.style.border = '';
                        button.style.boxShadow = '';
                        gameState.shakeInProgress = false;
                        
                        // Process any pending character advance
                        if (gameState.pendingCharacterAdvance) {
                            gameState.pendingCharacterAdvance = false;
                            setTimeout(processCharacterAdvance, 100);
                        }
                    }, 800);
                }
            });
        }

        function processCharacterAdvance() {
            // This handles the character advance after shake is complete
            removeActiveCharacterAndAdvance();
        }

        // Game Logic Functions
        function selectOption(optionIndex) {
            const selectedWord = gameState.currentOptions[optionIndex];
            const activeCharacter = gameState.charactersOnScreen[gameState.activeWordIndex];
            
            if (!selectedWord || !activeCharacter) return;
            
            gameSettings.mascot.lastInteraction = Date.now(); // Reset idle timer
            
            const isCorrect = selectedWord.chinese === activeCharacter.word.chinese;
            const button = gameState.optionButtons[optionIndex];
            const currentTime = Date.now();
            
            if (isCorrect) {
                // Handle correct answer
                const timeDiff = currentTime - gameState.lastAnswerTime;
                if (timeDiff < 1000 && gameState.lastAnswerTime > 0) {
                    gameState.streakCount++;
                } else {
                    gameState.streakCount = 1;
                }
                gameState.lastAnswerTime = currentTime;
                
                handleCorrectAnswer(selectedWord, button, optionIndex);
                gameState.alreadyPenalized = false;
            } else {
                // Handle incorrect answer
                gameState.streakCount = 0;
                handleIncorrectAnswer(activeCharacter.word, optionIndex);
                
                // FIXED: Delay character advance until after shake
                if (!gameState.shakeInProgress) {
                    highlightCorrectAnswer(activeCharacter.word);
                } else {
                    gameState.pendingCharacterAdvance = true;
                }
            }
        }

        function handleCorrectAnswer(word, button, optionIndex) {
            playSound('correct');
            button.classList.add('correct-animation');
            
            const progress = gameState.wordProgress[word.chinese];
            progress.count++;
            
            let tierChanged = false;
            const req = gameState.tierRequirement;
            
            if (progress.count === req && progress.tier === 'bronze') {
                progress.tier = 'silver';
                tierChanged = true;
            } else if (progress.count === req * 2 && progress.tier === 'silver') {
                progress.tier = 'gold';
                tierChanged = true;
            } else if (progress.count === req * 3 && progress.tier === 'gold') {
                // Word completed
                createStarAnimation(button);
                playStarShootAnimation();
                playSound('starShoot');
                queueMascotAnimation('celebrate');
                
                addNewWordToRotation(word, optionIndex);
                
                gameState.starsEarned++;
                gameState.completedWords++;
                updateUI();
                
                if (gameState.completedWords === gameState.selectedWords.length) {
                    setTimeout(() => alert('Congratulations! You completed all words!'), 1000);
                    return;
                }
                
                removeActiveCharacterAndAdvance();
                setTimeout(() => button.classList.remove('correct-animation'), 800);
                return;
            }
            
            if (tierChanged) {
                button.classList.add('tier-up');
                playSound('tierUp');
                setTimeout(() => button.classList.remove('tier-up'), 800);
            }
            
            updateOptionButton(optionIndex, word, progress);
            removeActiveCharacterAndAdvance();
            
            setTimeout(() => button.classList.remove('correct-animation'), 800);
        }

        function handleIncorrectAnswer(correctWord, selectedOptionIndex) {
            if (!gameSettings.ui.easyMode && !gameState.alreadyPenalized) {
                gameState.alreadyPenalized = true;
                
                let correctOptionIndex = -1;
                for (let i = 0; i < gameState.currentOptions.length; i++) {
                    if (gameState.currentOptions[i] && gameState.currentOptions[i].chinese === correctWord.chinese) {
                        correctOptionIndex = i;
                        break;
                    }
                }
                
                if (correctOptionIndex !== -1) {
                    const progress = gameState.wordProgress[correctWord.chinese];
                    const oldTier = progress.tier;
                    
                    if (progress.tier === 'gold') {
                        progress.tier = 'silver';
                    } else if (progress.tier === 'silver') {
                        progress.tier = 'bronze';
                    }
                    
                    if (oldTier !== progress.tier) {
                        queueMascotAnimation('sad');
                    } else if (progress.tier === 'bronze') {
                        queueMascotAnimation('ouch');
                    }
                    
                    updateOptionButton(correctOptionIndex, correctWord, progress);
                }
            } else {
                queueMascotAnimation('ouch');
            }
            
            playSound('incorrect');
        }

        function updateOptionButton(optionIndex, word, progress) {
            const button = gameState.optionButtons[optionIndex];
            button.className = `option-btn tier-${progress.tier}`;
            
            const progressPercent = (progress.count % gameState.tierRequirement) * (100/gameState.tierRequirement);
            const progressFill = button.querySelector('.progress-fill');
            const progressCount = button.querySelector('.progress-count');
            
            if (progressFill) {
                progressFill.style.width = `${progressPercent}%`;
            }
            if (progressCount) {
                progressCount.textContent = `${progress.count}/${gameState.tierRequirement}`;
            }
        }

        function createStarAnimation(button) {
            const star = document.createElement('div');
            star.innerHTML = '⭐';
            star.className = 'float-up';
            star.style.position = 'absolute';
            star.style.fontSize = '2rem';
            star.style.left = '50%';
            star.style.top = '50%';
            star.style.transform = 'translate(-50%, -50%)';
            star.style.pointerEvents = 'none';
            star.style.zIndex = '1000';
            
            button.style.position = 'relative';
            button.appendChild(star);
            
            setTimeout(() => {
                if (star.parentNode) star.parentNode.removeChild(star);
            }, 1000);
        }

        function playStarShootAnimation() {
            const starIcon = document.getElementById('starIcon');
            starIcon.classList.add('star-shoot');
            setTimeout(() => starIcon.classList.remove('star-shoot'), 1200);
        }

        function addNewWordToRotation(completedWord, optionIndex) {
            const availableWords = gameState.selectedWords.filter(word => 
                gameState.wordProgress[word.chinese].count < gameState.tierRequirement * 3 &&
                !gameState.currentWords.some(w => w.chinese === word.chinese)
            );
            
            gameState.currentWords = gameState.currentWords.filter(word => 
                word.chinese !== completedWord.chinese
            );
            
            removeCompletedWordFromCharacters(completedWord.chinese);
            
            if (availableWords.length > 0) {
                const newWord = availableWords[Math.floor(Math.random() * availableWords.length)];
                gameState.currentWords.push(newWord);
                
                gameState.currentOptions[optionIndex] = newWord;
                const progress = gameState.wordProgress[newWord.chinese];
                
                const button = gameState.optionButtons[optionIndex];
                button.classList.add('new-word-entry');
                button.className = 'option-btn tier-bronze new-word-entry';
                
                const displayText = gameSettings.ui.pinyinMode ? newWord.pinyin : newWord.english;
                
                button.innerHTML = `
                    <span>${displayText}</span>
                    <div class="progress-count">${progress.count}/${gameState.tierRequirement}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${(progress.count % gameState.tierRequirement) * (100/gameState.tierRequirement)}%"></div>
                    </div>
                    <div class="hotkey">${gameState.hotkeys[optionIndex]}</div>
                `;
                
                setTimeout(() => button.classList.remove('new-word-entry'), 800);
            } else {
                gameState.currentOptions[optionIndex] = null;
                const button = gameState.optionButtons[optionIndex];
                button.className = 'option-btn tier-bronze';
                button.innerHTML = `
                    <span>COMPLETE</span>
                    <div class="hotkey">${gameState.hotkeys[optionIndex]}</div>
                `;
                button.style.opacity = '0.5';
            }
        }

        function removeCompletedWordFromCharacters(completedWordChinese) {
            gameState.charactersOnScreen = gameState.charactersOnScreen.filter(char => {
                if (char.word.chinese === completedWordChinese) {
                    char.element.classList.add('slide-left');
                    setTimeout(() => {
                        if (char.element.parentNode) {
                            char.element.parentNode.removeChild(char.element);
                        }
                    }, 500);
                    return false;
                }
                return true;
            });
            
            while (gameState.charactersOnScreen.length < 8) {
                const word = getRandomCurrentWord();
                const container = document.createElement('div');
                container.className = 'character-container upcoming';
                container.innerHTML = `
                    <div class="pinyin${gameSettings.ui.showPinyin ? '' : ' hidden'}">${word.pinyin}</div>
                    <div class="chinese-char">${getChineseChar(word)}</div>
                `;
                
                const chineseText = getChineseChar(word);
                const estimatedWidth = Math.max(120, chineseText.length * 30 + 40);
                container.style.width = `${estimatedWidth}px`;
                
                const charactersRow = document.getElementById('charactersRow');
                charactersRow.appendChild(container);
                gameState.charactersOnScreen.push({ element: container, word: word, width: estimatedWidth });
            }
            
            positionCharacterContainers();
            
            if (gameState.charactersOnScreen.length > 0) {
                setTimeout(() => playPronunciation(getChineseChar(gameState.charactersOnScreen[0].word)), 300);
            }
        }

        function updateUI() {
            document.getElementById('starsCount').textContent = gameState.starsEarned;
        }
  // Comprehensive State Cleanup
        function returnToMenu() {
            console.log('=== STARTING COMPLETE STATE CLEANUP ===');
            
            try {
                const audioElements = document.querySelectorAll('audio');
                audioElements.forEach(audio => {
                    if (audio.id !== 'backgroundMusic') {
                        audio.pause();
                        audio.src = '';
                        audio.load();
                    }
                });
                
                const ttsAudio = document.getElementById('tts-audio-element');
                if (ttsAudio) {
                    ttsAudio.pause();
                    ttsAudio.remove();
                }
                
                gameState.mascotAnimationQueue = [];
                gameState.mascotAnimationPlaying = false;
                gameState.sadAnimationActive = false;
                gameState.shakeInProgress = false;
                gameState.pendingCharacterAdvance = false;
            } catch (error) {
                console.log('Audio cleanup error:', error);
            }
            
            try {
                const optionsGrid = document.getElementById('optionsGrid');
                if (optionsGrid) {
                    const buttons = optionsGrid.querySelectorAll('.option-btn');
                    buttons.forEach(button => {
                        button.classList.remove('shake-animation', 'correct-animation', 'tier-up', 'new-word-entry');
                        button.style.border = '';
                        button.style.boxShadow = '';
                        button.style.transform = '';
                        button.style.opacity = '';
                    });
                    optionsGrid.innerHTML = '';
                }
                
                const charactersRow = document.getElementById('charactersRow');
                if (charactersRow) {
                    const characterContainers = charactersRow.querySelectorAll('.character-container:not(.mascot-container)');
                    characterContainers.forEach(container => {
                        container.remove();
                    });
                }
                
                setMascotAnimation('walk');
                gameSettings.mascot.lastInteraction = Date.now();
            } catch (error) {
                console.log('DOM cleanup error:', error);
            }
            
            const preservedSettings = {
                hotkeys: [...gameState.hotkeys],
                easyMode: gameState.easyMode,
                mascotAnimations: { ...gameState.mascotAnimations },
                mascotAnimationDurations: { ...gameState.mascotAnimationDurations }
            };
            
            gameState = {
                selectedWords: [], currentWords: [], activeWordIndex: 0, wordProgress: {},
                starsEarned: 0, completedWords: 0, charactersOnScreen: [], optionButtons: [],
                currentOptions: [], streakCount: 0, lastAnswerTime: 0, alreadyPenalized: false,
                tierRequirement: 5, shakeInProgress: false, pendingCharacterAdvance: false,
                hotkeys: preservedSettings.hotkeys, easyMode: preservedSettings.easyMode,
                mascotAnimations: preservedSettings.mascotAnimations,
                mascotAnimationDurations: preservedSettings.mascotAnimationDurations,
                mascotAnimationQueue: [], currentMascotAnimation: 'walk',
                mascotAnimationPlaying: false, sadAnimationActive: false
            };
            
            for (let i = 1; i < 10000; i++) {
                clearTimeout(i);
                clearInterval(i);
            }
            
            updateSettingsToggles();
            
            const mobileMenu = document.getElementById('mobileMenu');
            if (mobileMenu) {
                mobileMenu.classList.remove('active');
            }
            
            console.log('=== STATE CLEANUP COMPLETE ===');
            
            document.getElementById('gamePage').style.display = 'none';
            document.getElementById('landingPage').style.display = 'flex';
        }

        function updateSettingsToggles() {
            const easyToggle = document.getElementById('easyModeToggleSettings');
            const traditionalToggle = document.getElementById('traditionalToggleSettings');
            
            if (gameState.easyMode) {
                easyToggle?.classList.add('active');
            } else {
                easyToggle?.classList.remove('active');
            }
            
            if (useTraditional) {
                traditionalToggle?.classList.add('active');
            } else {
                traditionalToggle?.classList.remove('active');
            }
        }

        function initializeGame() {
            console.log('=== INITIALIZING FRESH GAME ===');
            
            gameState.activeWordIndex = 0;
            gameState.charactersOnScreen = [];
            gameState.optionButtons = [];
            gameState.currentOptions = [];
            gameState.streakCount = 0;
            gameState.lastAnswerTime = 0;
            gameState.alreadyPenalized = false;
            gameState.shakeInProgress = false;
            gameState.pendingCharacterAdvance = false;
            
            setupCharactersRow();
            setupOptionsGrid();
            setupKeyboardListeners();
            
            setMascotAnimation('walk');
            gameSettings.mascot.lastInteraction = Date.now();
            
            if (gameSettings.music.enabled) {
                const bgMusic = document.getElementById('backgroundMusic');
                if (bgMusic) {
                    bgMusic.play().catch(e => console.log('Background music failed to start:', e));
                }
            }
            
            console.log('=== GAME INITIALIZATION COMPLETE ===');
        }

        function setupCharactersRow() {
            const charactersRow = document.getElementById('charactersRow');
            
            const existingCharacters = charactersRow.querySelectorAll('.character-container:not(.mascot-container)');
            existingCharacters.forEach(char => char.remove());
            
            gameState.charactersOnScreen = [];
            
            if (gameState.currentWords.length === 0) {
                console.error('No current words available for character setup!');
                return;
            }
            
            for (let i = 0; i < 8; i++) {
                const word = getRandomCurrentWord();
                const container = document.createElement('div');
                
                if (i === 0) {
                    container.className = 'character-container active';
                    gameState.activeWordIndex = 0;
                    setTimeout(() => playPronunciation(getChineseChar(word)), 300);
                } else if (i <= 2) {
                    container.className = 'character-container next';
                } else {
                    container.className = 'character-container upcoming';
                }
                
                container.innerHTML = `
                    <div class="pinyin${gameSettings.ui.showPinyin ? '' : ' hidden'}">${word.pinyin}</div>
                    <div class="chinese-char">${getChineseChar(word)}</div>
                `;
                
                const chineseText = getChineseChar(word);
                const estimatedWidth = Math.max(120, chineseText.length * 30 + 40);
                container.style.width = `${estimatedWidth}px`;
                
                const charactersRow = document.getElementById('charactersRow');
                charactersRow.appendChild(container);
                gameState.charactersOnScreen.push({ element: container, word: word, width: estimatedWidth });
            }
            
            positionCharacterContainers();
            
            if (gameState.charactersOnScreen.length > 0) {
                setTimeout(() => playPronunciation(getChineseChar(gameState.charactersOnScreen[0].word)), 300);
            }
        }

        function updateUI() {
            document.getElementById('starsCount').textContent = gameState.starsEarned;
        }

        function updateRange() {
            const startInput = document.getElementById('startInput');
            const endInput = document.getElementById('endInput');
            const maxWords = parseInt(startInput.max);
            
            let start = parseInt(startInput.value);
            let end = parseInt(endInput.value);
            
            start = Math.max(1, Math.min(start, maxWords));
            end = Math.max(1, Math.min(end, maxWords));
            
            if (start > end) {
                end = start;
            }
            
            startInput.value = start;
            endInput.value = end;
            
            const totalSelected = end - start + 1;
            
            document.getElementById('startValue').textContent = start;
            document.getElementById('endValue').textContent = end;
            document.getElementById('totalWords').textContent = totalSelected;
            
            const progressFill = document.getElementById('rangeProgressFill');
            const progressText = document.getElementById('rangeProgressText');
            
            if (progressFill && progressText) {
                const percentage = (totalSelected / maxWords) * 100;
                progressFill.style.width = `${percentage}%`;
                progressText.textContent = `${totalSelected} / ${maxWords} words`;
            }
        }

        function toggleRandomize() {
            randomizeWords = !randomizeWords;
            const checkbox = document.getElementById('randomizeCheckbox');
            
            if (randomizeWords) {
                checkbox.classList.add('checked');
            } else {
                checkbox.classList.remove('checked');
            }
        }

        function startGame(allWords) {
            if (hskWords.length === 0) {
                alert('Please wait for the wordlist to load, then try again.');
                return;
            }
            
            let startIndex, endIndex;
            
            if (allWords) {
                startIndex = 1;
                endIndex = hskWords.length;
            } else {
                startIndex = parseInt(document.getElementById('startInput').value);
                endIndex = parseInt(document.getElementById('endInput').value);
            }
            
            gameState.tierRequirement = parseInt(document.getElementById('landingTierRequirement').value);
            
            let selectedWords = hskWords.slice(startIndex - 1, endIndex);
            
            if (randomizeWords) {
                selectedWords = shuffleArray([...selectedWords]);
            }
            
            gameState.selectedWords = selectedWords;
            gameState.currentWords = gameState.selectedWords.slice(0, Math.min(10, gameState.selectedWords.length));
            
            gameState.wordProgress = {};
            gameState.selectedWords.forEach(word => {
                gameState.wordProgress[word.chinese] = { count: 0, tier: 'bronze' };
            });
            
            gameState.starsEarned = 0;
            gameState.completedWords = 0;
            gameState.activeWordIndex = 0;
            gameState.charactersOnScreen = [];
            gameState.streakCount = 0;
            gameState.lastAnswerTime = 0;
            gameState.alreadyPenalized = false;
            gameState.sadAnimationActive = false;
            gameState.shakeInProgress = false;
            gameState.pendingCharacterAdvance = false;
            
            document.getElementById('totalStarsCount').textContent = gameState.selectedWords.length;
            document.getElementById('starsCount').textContent = gameState.starsEarned;
            
            document.getElementById('landingPage').style.display = 'none';
            document.getElementById('gamePage').style.display = 'flex';
            
            initializeGame();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startListening(index) {
            listeningForInput = index;
            const input = document.querySelectorAll('.hotkey-input')[index];
            input.classList.add('listening');
            input.value = 'Press any key...';
            input.focus();
        }

        function updateHotkey(index, newKey) {
            if (newKey.length >= 1) {
                gameState.hotkeys[index] = newKey.toUpperCase();
                const input = document.querySelectorAll('.hotkey-input')[index];
                input.value = newKey.toUpperCase();
                input.classList.remove('listening');
                listeningForInput = -1;
            }
        }

        function setupKeyboardListeners() {
            document.addEventListener('keydown', (event) => {
                if (listeningForInput !== -1) {
                    event.preventDefault();
                    updateHotkey(listeningForInput, event.key);
                    return;
                }
                
                if (document.getElementById('settingsModal').style.display === 'block') {
                    if (event.key === 'Escape') {
                        closeSettings();
                    }
                    return;
                }
                
                const pressedKey = event.key.toUpperCase();
                const optionIndex = gameState.hotkeys.indexOf(pressedKey);
                
                if (optionIndex !== -1) {
                    event.preventDefault();
                    selectOption(optionIndex);
                }
            });
        }

        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            mobileMenu.classList.toggle('active');
        }

        document.addEventListener('click', function(event) {
            const mobileMenu = document.getElementById('mobileMenu');
            const toggleButton = document.querySelector('.mobile-menu-toggle');
            
            if (mobileMenu && !mobileMenu.contains(event.target) && !toggleButton.contains(event.target)) {
                mobileMenu.classList.remove('active');
            }
        });

        async function changeBand() {
            const bandSelector = document.getElementById('bandSelector');
            const selectedBand = parseInt(bandSelector.value);
            
            const startButtons = document.querySelectorAll('.start-button');
            startButtons.forEach(btn => {
                btn.disabled = true;
                btn.textContent = 'Loading...';
            });
            
            const success = await loadHSKWords(selectedBand);
            
            startButtons.forEach((btn, index) => {
                btn.disabled = false;
                btn.textContent = index === 0 ? 'Custom Selection' : `All Words (Band ${selectedBand})`;
            });
            
            if (success) {
                currentBand = selectedBand;
            } else {
                bandSelector.value = currentBand;
                alert(`Failed to load Band ${selectedBand} wordlist. Using Band ${currentBand}.`);
            }
        }

        async function initializeApp() {
            await loadHSKWords(1);
            updateRange();
            initializeBackgroundMusic();
            setupIdleDetection();
            console.log('App initialized with enhanced audio and UI support');
        }

        window.addEventListener('DOMContentLoaded', initializeApp);
    </script>
    
    <footer class="bg-[#797d62] text-white py-4 border-t border-gray-700 mt-auto">
        <div class="container mx-auto px-4 flex flex-col sm:flex-row justify-between items-center">
            <div class="flex flex-col sm:items-start items-center mb-2 sm:mb-0">
                <p class="text-sm mb-1 rounded-md flex items-center">
                    <i class="fab fa-patreon text-lg mr-2"></i>
                    Patreon:
                    <a href="https://www.patreon.com/UnfinishedProjects" target="_blank" rel="noopener noreferrer" class="text-blue-100 hover:underline font-medium rounded-md px-2 py-1 transition duration-300 ease-in-out">
                        @UnfinishedProjects
                    </a>
                </p>
                <p class="text-sm rounded-md flex items-center">
                    <i class="fab fa-github text-lg mr-2"></i>
                    GitHub Repository:
                    <a href="https://github.com/GreenAnts/HSK-3.0-Study-Game" target="_blank" rel="noopener noreferrer" class="text-blue-100 hover:underline font-medium rounded-md px-2 py-1 transition duration-300 ease-in-out">
                        HSK-3.0-Study-Game
                    </a>
                </p>
            </div>

            <div class="flex flex-col sm:items-end items-center">
                <p class="text-sm rounded-md flex items-center">
                    <i class="fas fa-palette text-lg mr-2"></i>
                    Mascot Attribution:
                    <a href="https://atari-boy.itch.io/" target="_blank" rel="noopener noreferrer" class="text-blue-100 hover:underline font-medium rounded-md px-2 py-1 transition duration-300 ease-in-out">
                        Atari Boy
                    </a>
                </p>
            </div>
        </div>
    </footer>
</body>
</html>
