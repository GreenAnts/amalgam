<!DOCTYPE html>
<html>
<head>
    <title>Fireball Animation Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
        }
        
        .nav-header {
            background: #333;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .nav-btn {
            display: inline-block;
            padding: 8px 16px;
            margin-right: 10px;
            background: #555;
            color: white;
            text-decoration: none;
            border-radius: 3px;
            transition: background 0.3s;
        }
        
        .nav-btn:hover {
            background: #777;
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-header h1 {
            color: #ff6b6b;
            margin: 0;
        }
        
        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .control-group {
            background: #333;
            padding: 15px;
            border-radius: 5px;
            min-width: 200px;
        }
        
        .control-group h3 {
            margin: 0 0 10px 0;
            color: #ff6b6b;
        }
        
        .control-group button {
            background: #ff4400;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: background 0.3s;
        }
        
        .control-group button:hover {
            background: #ff6600;
        }
        
        .control-group button.amplified {
            background: #ff2200;
        }
        
        .control-group button.amplified:hover {
            background: #ff4400;
        }
        
        .canvas-container {
            text-align: center;
            margin-top: 20px;
            position: relative;
        }
        
        #gameCanvas {
            border: 2px solid #555;
            border-radius: 5px;
            background: #000;
            cursor: crosshair;
        }
        
        .info-panel {
            background: #333;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .info-panel h3 {
            margin: 0 0 10px 0;
            color: #ff6b6b;
        }
        
        .info-panel p {
            margin: 5px 0;
            line-height: 1.4;
        }
        
        .status-panel {
            background: #333;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .status-panel h3 {
            margin: 0 0 10px 0;
            color: #ff6b6b;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 5px 0;
            border-bottom: 1px solid #555;
        }
        
        .status-item:last-child {
            border-bottom: none;
        }
        
        .formation-display {
            background: #333;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .formation-display h3 {
            margin: 0 0 10px 0;
            color: #ff6b6b;
        }
        
        .piece-info {
            display: flex;
            gap: 20px;
            margin: 10px 0;
        }
        
        .piece {
            background: #555;
            padding: 10px;
            border-radius: 5px;
            min-width: 100px;
        }
        
        .piece.ruby {
            border-left: 4px solid #ff4400;
        }
        
        .piece.amalgam {
            border-left: 4px solid #E63960;
        }
        
        .piece.void {
            border-left: 4px solid #5B4E7A;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation Header -->
        <div class="nav-header">
            <a href="../../../tests.html" class="nav-btn">Testing Hub</a>
            <a href="../../comprehensive-game-mechanics-test.html" class="nav-btn">Full Suite</a>
        </div>
        
        <div class="test-header">
            <h1>Fireball Animation Test</h1>
        </div>
        
        <!-- Controls -->
        <div class="controls">
            <div class="control-group">
                <h3>Standard Fireball</h3>
                <p>Ruby + Ruby formation</p>
                <button onclick="createStandardFireball()">Cast Standard Fireball</button>
                <button onclick="createRandomStandardFireball()">Random Standard</button>
            </div>
            
            <div class="control-group">
                <h3>Amplified Fireball</h3>
                <p>Ruby + Ruby + Void formation</p>
                <button class="amplified" onclick="createAmplifiedFireball()">Cast Amplified Fireball</button>
                <button class="amplified" onclick="createRandomAmplifiedFireball()">Random Amplified</button>
            </div>
            
            <div class="control-group">
                <h3>Formation Controls</h3>
                <button onclick="setFormation('horizontal')">Horizontal Formation</button>
                <button onclick="setFormation('vertical')">Vertical Formation</button>
                <button onclick="setFormation('diagonal')">Diagonal Formation</button>
                <button onclick="clearAll()">Clear All</button>
            </div>
            
            <div class="control-group">
                <h3>Target Controls</h3>
                <button onclick="setTarget('near')">Near Target</button>
                <button onclick="setTarget('far')">Far Target</button>
                <button onclick="setTarget('random')">Random Target</button>
            </div>
        </div>
        
        <!-- Canvas -->
        <div class="canvas-container">
            <canvas id="gameCanvas" width="800" height="600"></canvas>
        </div>
        
        <!-- Formation Display -->
        <div class="formation-display">
            <h3>Current Formation</h3>
            <div class="piece-info">
                <div class="piece ruby">
                    <strong>Piece 1 (Ruby)</strong><br>
                    <span id="piece1Pos">Click to set</span>
                </div>
                <div class="piece ruby">
                    <strong>Piece 2 (Ruby)</strong><br>
                    <span id="piece2Pos">Click to set</span>
                </div>
                <div class="piece void" id="voidPiece" style="display: none;">
                    <strong>Void (Amplifier)</strong><br>
                    <span id="voidPos">Click to set</span>
                </div>
            </div>
            <p><strong>Target:</strong> <span id="targetPos">Click to set</span></p>
        </div>
        
        <!-- Status Panel -->
        <div class="status-panel">
            <h3>Animation Status</h3>
            <div class="status-item">
                <span>Active Animations:</span>
                <span id="activeCount">0</span>
            </div>
            <div class="status-item">
                <span>Formation Type:</span>
                <span id="formationType">None</span>
            </div>
            <div class="status-item">
                <span>Amplified:</span>
                <span id="amplifiedStatus">No</span>
            </div>
            <div class="status-item">
                <span>Last Action:</span>
                <span id="lastAction">None</span>
            </div>
        </div>
        
        <!-- Info Panel -->
        <div class="info-panel">
            <h3>Instructions</h3>
            <p><strong>Click on the canvas</strong> to set formation pieces and target</p>
            <p><strong>Use the buttons</strong> to create different fireball types</p>
            <p><strong>Formation phases:</strong> Figure-8 particles → Gather → Fire → Impact</p>
            <p><strong>Amplified fireballs</strong> have more particles and longer range</p>
        </div>
    </div>
    
    <script type="module">
        import { FireballAnimationManager } from './fireball-animation.js';
        
        class FireballTest {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.animationManager = new FireballAnimationManager(this.canvas);
                this.lastTime = 0;
                
                // Formation state
                this.formationPieces = [];
                this.targetPosition = null;
                this.isAmplified = false;
                this.formationType = 'none';
                
                this.initializeEventListeners();
                this.startAnimation();
            }
            
            initializeEventListeners() {
                // Canvas click events
                this.canvas.addEventListener('click', (e) => {
                    const rect = this.canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    this.handleCanvasClick(x, y);
                });
                
                // Right click to clear
                this.canvas.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    this.clearFormation();
                });
            }
            
            handleCanvasClick(x, y) {
                if (this.formationPieces.length < 2) {
                    // Add formation piece
                    this.formationPieces.push({ x, y });
                    this.updateFormationDisplay();
                    
                    if (this.formationPieces.length === 2) {
                        document.getElementById('lastAction').textContent = 'Formation complete - click to set target';
                    }
                } else if (this.isAmplified && this.formationPieces.length < 3) {
                    // Add void piece for amplified formation
                    this.formationPieces.push({ x, y });
                    this.updateFormationDisplay();
                    document.getElementById('lastAction').textContent = 'Void added - click to set target';
                } else if (!this.targetPosition) {
                    // Set target
                    this.targetPosition = { x, y };
                    this.updateFormationDisplay();
                    document.getElementById('lastAction').textContent = 'Target set - ready to cast';
                }
            }
            
            createFireball() {
                if (this.formationPieces.length < 2 || !this.targetPosition) {
                    document.getElementById('lastAction').textContent = 'Need 2 pieces and target to cast fireball';
                    return;
                }
                
                const sourcePieces = this.formationPieces.slice(0, 2);
                const animationId = this.animationManager.createFireballAnimation(
                    sourcePieces,
                    this.targetPosition,
                    this.isAmplified
                );
                
                document.getElementById('lastAction').textContent = `Casted ${this.isAmplified ? 'amplified' : 'standard'} fireball`;
                this.updateStatus();
            }
            
            setFormation(type) {
                this.formationType = type;
                this.clearFormation();
                
                const centerX = this.canvas.width / 2;
                const centerY = this.canvas.height / 2;
                
                switch (type) {
                    case 'horizontal':
                        this.formationPieces = [
                            { x: centerX - 50, y: centerY },
                            { x: centerX + 50, y: centerY }
                        ];
                        break;
                    case 'vertical':
                        this.formationPieces = [
                            { x: centerX, y: centerY - 50 },
                            { x: centerX, y: centerY + 50 }
                        ];
                        break;
                    case 'diagonal':
                        this.formationPieces = [
                            { x: centerX - 35, y: centerY - 35 },
                            { x: centerX + 35, y: centerY + 35 }
                        ];
                        break;
                }
                
                this.updateFormationDisplay();
                document.getElementById('lastAction').textContent = `${type} formation set`;
            }
            
            setTarget(type) {
                if (this.formationPieces.length < 2) {
                    document.getElementById('lastAction').textContent = 'Set formation first';
                    return;
                }
                
                const forwardPiece = this.formationPieces[1];
                
                switch (type) {
                    case 'near':
                        this.targetPosition = {
                            x: forwardPiece.x + 100,
                            y: forwardPiece.y
                        };
                        break;
                    case 'far':
                        this.targetPosition = {
                            x: forwardPiece.x + 200,
                            y: forwardPiece.y
                        };
                        break;
                    case 'random':
                        this.targetPosition = {
                            x: Math.random() * this.canvas.width,
                            y: Math.random() * this.canvas.height
                        };
                        break;
                }
                
                this.updateFormationDisplay();
                document.getElementById('lastAction').textContent = `${type} target set`;
            }
            
            clearFormation() {
                this.formationPieces = [];
                this.targetPosition = null;
                this.isAmplified = false;
                this.updateFormationDisplay();
                document.getElementById('lastAction').textContent = 'Formation cleared';
            }
            
            clearAll() {
                this.clearFormation();
                this.animationManager.clearAll();
                this.updateStatus();
                document.getElementById('lastAction').textContent = 'All cleared';
            }
            
            updateFormationDisplay() {
                // Update piece positions
                document.getElementById('piece1Pos').textContent = 
                    this.formationPieces[0] ? `(${Math.round(this.formationPieces[0].x)}, ${Math.round(this.formationPieces[0].y)})` : 'Not set';
                document.getElementById('piece2Pos').textContent = 
                    this.formationPieces[1] ? `(${Math.round(this.formationPieces[1].x)}, ${Math.round(this.formationPieces[1].y)})` : 'Not set';
                document.getElementById('voidPos').textContent = 
                    this.formationPieces[2] ? `(${Math.round(this.formationPieces[2].x)}, ${Math.round(this.formationPieces[2].y)})` : 'Not set';
                
                // Update target position
                document.getElementById('targetPos').textContent = 
                    this.targetPosition ? `(${Math.round(this.targetPosition.x)}, ${Math.round(this.targetPosition.y)})` : 'Not set';
                
                // Show/hide void piece
                const voidElement = document.getElementById('voidPiece');
                if (this.isAmplified) {
                    voidElement.style.display = 'block';
                } else {
                    voidElement.style.display = 'none';
                }
                
                // Update status
                document.getElementById('formationType').textContent = this.formationType;
                document.getElementById('amplifiedStatus').textContent = this.isAmplified ? 'Yes' : 'No';
            }
            
            updateStatus() {
                document.getElementById('activeCount').textContent = 
                    this.animationManager.getActiveAnimationCount();
            }
            
            startAnimation() {
                const animate = (currentTime) => {
                    const deltaTime = currentTime - this.lastTime;
                    this.lastTime = currentTime;
                    
                    // Clear canvas
                    this.ctx.fillStyle = '#000';
                    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                    
                    // Draw formation pieces
                    this.drawFormationPieces();
                    
                    // Update and render animations
                    this.animationManager.update(deltaTime);
                    this.animationManager.draw(this.ctx);
                    
                    // Update status
                    this.updateStatus();
                    
                    requestAnimationFrame(animate);
                };
                
                requestAnimationFrame(animate);
            }
            
            drawFormationPieces() {
                // Draw formation pieces
                this.formationPieces.forEach((piece, index) => {
                    this.ctx.save();
                    
                    if (index < 2) {
                        // Ruby pieces
                        this.ctx.fillStyle = '#ff4400';
                        this.ctx.strokeStyle = '#ff6600';
                    } else {
                        // Void piece
                        this.ctx.fillStyle = '#5B4E7A';
                        this.ctx.strokeStyle = '#8D7EA9';
                    }
                    
                    this.ctx.lineWidth = 2;
                    this.ctx.beginPath();
                    this.ctx.arc(piece.x, piece.y, 15, 0, Math.PI * 2);
                    this.ctx.fill();
                    this.ctx.stroke();
                    
                    // Draw piece number
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = '12px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText(index + 1, piece.x, piece.y + 4);
                    
                    this.ctx.restore();
                });
                
                // Draw target
                if (this.targetPosition) {
                    this.ctx.save();
                    this.ctx.fillStyle = '#ff0000';
                    this.ctx.strokeStyle = '#ff6666';
                    this.ctx.lineWidth = 2;
                    this.ctx.beginPath();
                    this.ctx.arc(this.targetPosition.x, this.targetPosition.y, 12, 0, Math.PI * 2);
                    this.ctx.fill();
                    this.ctx.stroke();
                    
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = '10px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText('T', this.targetPosition.x, this.targetPosition.y + 3);
                    
                    this.ctx.restore();
                }
            }
        }
        
        // Global functions for button interactions
        window.createStandardFireball = function() {
            testInstance.isAmplified = false;
            testInstance.createFireball();
        };
        
        window.createAmplifiedFireball = function() {
            testInstance.isAmplified = true;
            testInstance.createFireball();
        };
        
        window.createRandomStandardFireball = function() {
            testInstance.isAmplified = false;
            testInstance.setFormation('diagonal');
            testInstance.setTarget('random');
            testInstance.createFireball();
        };
        
        window.createRandomAmplifiedFireball = function() {
            testInstance.isAmplified = true;
            testInstance.setFormation('horizontal');
            testInstance.setTarget('far');
            testInstance.createFireball();
        };
        
        window.setFormation = function(type) {
            testInstance.setFormation(type);
        };
        
        window.setTarget = function(type) {
            testInstance.setTarget(type);
        };
        
        window.clearAll = function() {
            testInstance.clearAll();
        };
        
        // Initialize the test when the page loads
        let testInstance;
        window.addEventListener('load', () => {
            testInstance = new FireballTest();
        });
    </script>
</body>
</html>
