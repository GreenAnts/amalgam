<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amalgam Comprehensive Test Suite</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #fafafa;
        }
        .test-result {
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .test-success {
            background: #d4edda;
            color: #155724;
            border-left-color: #28a745;
        }
        .test-error {
            background: #f8d7da;
            color: #721c24;
            border-left-color: #dc3545;
        }
        .test-warning {
            background: #fff3cd;
            color: #856404;
            border-left-color: #ffc107;
        }
        .test-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left-color: #17a2b8;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .run-all {
            background: #28a745;
            font-weight: bold;
            font-size: 16px;
        }
        .run-all:hover {
            background: #218838;
        }
        .debug-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .visual-test {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }
        .canvas-container {
            border: 2px solid #333;
            background: white;
        }
        .test-controls {
            min-width: 200px;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }
        h3 {
            color: #555;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🧪 Amalgam Game - Comprehensive Test Suite</h1>
        
        <div class="test-section">
            <button class="run-all" onclick="runAllTests()">🚀 Run All Tests</button>
            <button onclick="clearAllResults()">🗑️ Clear Results</button>
        </div>

        <div class="test-section">
            <h3>📊 Data Loading & Validation Tests</h3>
            <button onclick="testDataLoading()">Test Data Loading</button>
            <button onclick="testBoardDataStructure()">Test Board Data Structure</button>
            <button onclick="testPieceDefinitions()">Test Piece Definitions</button>
            <div id="data-test-results"></div>
        </div>

        <div class="test-section">
            <h3>🏗️ Board Construction Tests</h3>
            <button onclick="testBoardGeneration()">Test Board Generation</button>
            <button onclick="testBoardDictionary()">Test Board Dictionary</button>
            <button onclick="testGoldenConnections()">Test Golden Connections</button>
            <div id="board-test-results"></div>
        </div>

        <div class="test-section">
            <h3>🎨 Graphics Rendering Tests</h3>
            <button onclick="testCanvasCreation()">Test Canvas Creation</button>
            <button onclick="testBoardRendering()">Test Board Rendering</button>
            <button onclick="testIntersectionCounts()">Test Intersection Counts</button>
            <div id="graphics-test-results"></div>
        </div>

        <div class="test-section">
            <h3>👾 Game Logic Tests</h3>
            <button onclick="testGameInitialization()">Test Game Initialization</button>
            <button onclick="testPieceVisibility()">Test Piece Visibility</button>
            <button onclick="testSetupPhase()">Test Setup Phase</button>
            <div id="game-test-results"></div>
        </div>

        <div class="test-section">
            <h3>🔍 Visual Debug Test</h3>
            <button onclick="createVisualTest()">Create Visual Test Canvas</button>
            <div id="visual-test-container" class="visual-test"></div>
        </div>

        <div class="test-section">
            <h3>📝 Debug Output</h3>
            <button onclick="clearDebugOutput()">Clear Debug</button>
            <div id="debug-output" class="debug-output"></div>
        </div>
    </div>

    <script type="module">
        const cacheBust = Date.now();
        let testResults = {};
        
        window.debugLog = function(message, data = null) {
            const debugDiv = document.getElementById('debug-output');
            const timestamp = new Date().toLocaleTimeString();
            let logEntry = `[${timestamp}] ${message}`;
            if (data) {
                logEntry += '\n' + JSON.stringify(data, null, 2);
            }
            debugDiv.innerHTML += logEntry + '\n\n';
            debugDiv.scrollTop = debugDiv.scrollHeight;
            console.log(message, data);
        };

        window.clearDebugOutput = function() {
            document.getElementById('debug-output').innerHTML = '';
        };

        window.clearAllResults = function() {
            ['data-test-results', 'board-test-results', 'graphics-test-results', 'game-test-results'].forEach(id => {
                document.getElementById(id).innerHTML = '';
            });
            testResults = {};
            clearDebugOutput();
        };

        function addTestResult(containerId, testName, success, message, details = null) {
            const container = document.getElementById(containerId);
            const resultClass = success ? 'test-success' : 'test-error';
            const icon = success ? '✅' : '❌';
            
            let html = `<div class="test-result ${resultClass}">
                <strong>${icon} ${testName}</strong><br/>
                ${message}`;
            
            if (details) {
                html += `<div class="debug-output">${JSON.stringify(details, null, 2)}</div>`;
            }
            
            html += '</div>';
            container.innerHTML += html;
            
            testResults[testName] = { success, message, details };
            debugLog(`Test: ${testName} - ${success ? 'PASS' : 'FAIL'}: ${message}`, details);
        }

        window.testDataLoading = async function() {
            try {
                debugLog('Testing data loading...');
                
                // Test board data
                const boardResponse = await fetch(`../data/board-data.json?v=${cacheBust}`);
                if (!boardResponse.ok) throw new Error(`Board data fetch failed: ${boardResponse.status}`);
                const boardData = await boardResponse.json();
                
                // Test piece definitions 
                const pieceResponse = await fetch(`../data/piece-definitions.json?v=${cacheBust}`);
                if (!pieceResponse.ok) throw new Error(`Piece definitions fetch failed: ${pieceResponse.status}`);
                const pieceDefs = await pieceResponse.json();
                
                addTestResult('data-test-results', 'Data Loading', true, 
                    `Board schema: ${boardData.schema}, Piece types loaded successfully`, 
                    { boardDataKeys: Object.keys(boardData), pieceDefsKeys: Object.keys(pieceDefs) });
                    
            } catch (error) {
                addTestResult('data-test-results', 'Data Loading', false, error.message);
            }
        };

        window.testBoardDataStructure = async function() {
            try {
                debugLog('Testing board data structure...');
                
                const boardResponse = await fetch(`../data/board-data.json?v=${cacheBust}`);
                const boardData = await boardResponse.json();
                
                // Check required sections
                const requiredSections = ['golden_lines', 'board', 'golden_coordinates', 'standard_coordinates'];
                const missingSections = requiredSections.filter(section => !boardData[section]);
                
                if (missingSections.length > 0) {
                    throw new Error(`Missing required sections: ${missingSections.join(', ')}`);
                }
                
                // Check golden lines
                if (!boardData.golden_lines.golden_lines_dict || typeof boardData.golden_lines.golden_lines_dict !== 'object') {
                    throw new Error('golden_lines.golden_lines_dict is missing or not an object');
                }
                
                // Check coordinates
                if (!boardData.golden_coordinates || !Array.isArray(boardData.golden_coordinates)) {
                    throw new Error('golden_coordinates is missing or not an array');
                }
                
                if (!boardData.standard_coordinates || !Array.isArray(boardData.standard_coordinates)) {
                    throw new Error('standard_coordinates is missing or not an array');
                }
                
                const goldenCoordCount = boardData.golden_coordinates.length;
                const standardCoordCount = boardData.standard_coordinates.length;
                const goldenDictCount = Object.keys(boardData.golden_lines.golden_lines_dict).length;
                
                addTestResult('board-test-results', 'Board Data Structure', true, 
                    `Structure valid. Golden coords: ${goldenCoordCount}, Standard coords: ${standardCoordCount}, Golden dict entries: ${goldenDictCount}`, 
                    { goldenCoordCount, standardCoordCount, goldenDictCount });
                    
            } catch (error) {
                addTestResult('board-test-results', 'Board Data Structure', false, error.message);
            }
        };

        window.testBoardGeneration = async function() {
            try {
                debugLog('Testing board generation...');
                
                const { createBoard } = await import(`../core/board.js?v=${cacheBust}`);
                const boardResponse = await fetch(`../data/board-data.json?v=${cacheBust}`);
                const boardData = await boardResponse.json();
                
                const board = createBoard(boardData);
                
                // Verify board structure
                if (!board.intersections || !Array.isArray(board.intersections)) {
                    throw new Error('Board missing intersections array');
                }
                
                if (!board.goldenLineConnections || !Array.isArray(board.goldenLineConnections)) {
                    throw new Error('Board missing goldenLineConnections array');
                }
                
                if (!board.width || !board.height) {
                    throw new Error('Board missing dimensions');
                }
                
                addTestResult('board-test-results', 'Board Generation', true, 
                    `Board generated successfully. Intersections: ${board.intersections.length}, Golden connections: ${board.goldenLineConnections.length}, Dimensions: ${board.width}x${board.height}`,
                    { intersectionCount: board.intersections.length, goldenConnectionCount: board.goldenLineConnections.length });
                    
            } catch (error) {
                addTestResult('board-test-results', 'Board Generation', false, error.message);
            }
        };

        window.testBoardDictionary = async function() {
            try {
                debugLog('Testing board dictionary creation...');
                
                const boardResponse = await fetch(`../data/board-data.json?v=${cacheBust}`);
                const boardData = await boardResponse.json();
                
                // Import graphics module to test createBoardDictionary (we need to expose it)
                const { createGameCanvas } = await import(`../ui/graphics.js?v=${cacheBust}`);
                
                // Create a temporary div to test canvas creation
                const tempDiv = document.createElement('div');
                tempDiv.style.display = 'none';
                document.body.appendChild(tempDiv);
                
                const canvasContext = createGameCanvas(tempDiv, boardData);
                
                // Test if boardDict was created
                if (!canvasContext.boardDict) {
                    throw new Error('Board dictionary not created');
                }
                
                const standardCount = Object.values(canvasContext.boardDict).filter(type => type === 'standard').length;
                const goldenCount = Object.values(canvasContext.boardDict).filter(type => type === 'golden').length;
                const totalCount = Object.keys(canvasContext.boardDict).length;
                
                // Sample some coordinates
                const sampleCoords = Object.keys(canvasContext.boardDict).slice(0, 5);
                
                document.body.removeChild(tempDiv);
                
                addTestResult('board-test-results', 'Board Dictionary', true, 
                    `Board dictionary created. Total: ${totalCount}, Standard: ${standardCount}, Golden: ${goldenCount}`,
                    { totalCount, standardCount, goldenCount, sampleCoords });
                    
            } catch (error) {
                addTestResult('board-test-results', 'Board Dictionary', false, error.message);
            }
        };

        window.testGoldenConnections = async function() {
            try {
                debugLog('Testing golden connections set...');
                
                const boardResponse = await fetch(`../data/board-data.json?v=${cacheBust}`);
                const boardData = await boardResponse.json();
                
                const { createGameCanvas } = await import(`../ui/graphics.js?v=${cacheBust}`);
                
                const tempDiv = document.createElement('div');
                tempDiv.style.display = 'none';
                document.body.appendChild(tempDiv);
                
                const canvasContext = createGameCanvas(tempDiv, boardData);
                
                if (!canvasContext.goldenConnections) {
                    throw new Error('Golden connections set not created');
                }
                
                const connectionCount = canvasContext.goldenConnections.size;
                const sampleConnections = Array.from(canvasContext.goldenConnections).slice(0, 5);
                
                document.body.removeChild(tempDiv);
                
                addTestResult('board-test-results', 'Golden Connections', true, 
                    `Golden connections set created with ${connectionCount} connections`,
                    { connectionCount, sampleConnections });
                    
            } catch (error) {
                addTestResult('board-test-results', 'Golden Connections', false, error.message);
            }
        };

        window.testCanvasCreation = async function() {
            try {
                debugLog('Testing canvas creation...');
                
                const boardResponse = await fetch(`../data/board-data.json?v=${cacheBust}`);
                const boardData = await boardResponse.json();
                
                const { createGameCanvas } = await import(`../ui/graphics.js?v=${cacheBust}`);
                
                const tempDiv = document.createElement('div');
                tempDiv.style.display = 'none';
                document.body.appendChild(tempDiv);
                
                const canvasContext = createGameCanvas(tempDiv, boardData);
                
                if (!canvasContext.canvas || !canvasContext.ctx) {
                    throw new Error('Canvas or context not created');
                }
                
                if (canvasContext.canvas.width !== 800 || canvasContext.canvas.height !== 800) {
                    throw new Error(`Canvas size incorrect: ${canvasContext.canvas.width}x${canvasContext.canvas.height}`);
                }
                
                document.body.removeChild(tempDiv);
                
                addTestResult('graphics-test-results', 'Canvas Creation', true, 
                    `Canvas created successfully. Size: ${canvasContext.canvas.width}x${canvasContext.canvas.height}`,
                    { width: canvasContext.canvas.width, height: canvasContext.canvas.height });
                    
            } catch (error) {
                addTestResult('graphics-test-results', 'Canvas Creation', false, error.message);
            }
        };

        window.testBoardRendering = async function() {
            try {
                debugLog('Testing board rendering...');
                
                const boardResponse = await fetch(`../data/board-data.json?v=${cacheBust}`);
                const boardData = await boardResponse.json();
                
                const { createGameCanvas } = await import(`../ui/graphics.js?v=${cacheBust}`);
                
                const tempDiv = document.createElement('div');
                tempDiv.style.display = 'none';
                document.body.appendChild(tempDiv);
                
                const canvasContext = createGameCanvas(tempDiv, boardData);
                
                // Test drawing
                canvasContext.drawBoard();
                
                // Check if canvas has been drawn to (non-blank)
                const imageData = canvasContext.ctx.getImageData(0, 0, canvasContext.canvas.width, canvasContext.canvas.height);
                const pixels = imageData.data;
                let hasNonWhitePixels = false;
                
                for (let i = 0; i < pixels.length; i += 4) {
                    if (pixels[i] !== 255 || pixels[i+1] !== 255 || pixels[i+2] !== 255) {
                        hasNonWhitePixels = true;
                        break;
                    }
                }
                
                document.body.removeChild(tempDiv);
                
                if (!hasNonWhitePixels) {
                    throw new Error('Canvas appears to be blank after drawing');
                }
                
                addTestResult('graphics-test-results', 'Board Rendering', true, 
                    'Board rendered successfully - canvas contains drawing data');
                    
            } catch (error) {
                addTestResult('graphics-test-results', 'Board Rendering', false, error.message);
            }
        };

        window.testIntersectionCounts = async function() {
            try {
                debugLog('Testing intersection counts...');
                
                const boardResponse = await fetch(`../data/board-data.json?v=${cacheBust}`);
                const boardData = await boardResponse.json();
                
                // Expected counts based on board data
                const totalPositions = boardData.golden_coordinates.length + boardData.standard_coordinates.length;
                const goldenPositions = boardData.golden_coordinates.length;
                const expectedStandard = boardData.standard_coordinates.length;
                
                debugLog('Expected intersection breakdown', {
                    totalPositions,
                    goldenPositions, 
                    expectedStandard
                });
                
                addTestResult('graphics-test-results', 'Intersection Counts', true, 
                    `Expected intersections: Total ${totalPositions}, Golden ${goldenPositions}, Standard ${expectedStandard}`,
                    { totalPositions, goldenPositions, expectedStandard });
                    
            } catch (error) {
                addTestResult('graphics-test-results', 'Intersection Counts', false, error.message);
            }
        };

        window.testGameInitialization = async function() {
            try {
                debugLog('Testing game initialization...');
                
                const { GameManager } = await import(`../game/gameManager.js?v=${cacheBust}`);
                
                const boardResponse = await fetch(`../data/board-data.json?v=${cacheBust}`);
                const boardData = await boardResponse.json();
                
                const pieceResponse = await fetch(`../data/piece-definitions.json?v=${cacheBust}`);
                const pieceDefs = await pieceResponse.json();
                
                const { createGameCanvas } = await import(`../ui/graphics.js?v=${cacheBust}`);
                
                const tempDiv = document.createElement('div');
                tempDiv.style.display = 'none';
                document.body.appendChild(tempDiv);
                
                const gameCanvas = createGameCanvas(tempDiv, boardData);
                
                const gameManager = new GameManager(gameCanvas, boardData, pieceDefs);
                const state = gameManager.getState();
                
                if (!state) {
                    throw new Error('Game state not initialized');
                }
                
                const pieceCount = Object.keys(state.pieces).length;
                
                addTestResult('game-test-results', 'Game Initialization', true, 
                    `Game initialized successfully. Game phase: ${state.gamePhase}, Current player: ${state.currentPlayer}, Pieces: ${pieceCount}`,
                    { gamePhase: state.gamePhase, currentPlayer: state.currentPlayer, pieceCount });
                    
            } catch (error) {
                addTestResult('game-test-results', 'Game Initialization', false, error.message);
            }
        };

        window.testPieceVisibility = async function() {
            try {
                debugLog('Testing piece visibility...');
                
                const { createInitialState, createBoard } = await import(`../core/board.js?v=${cacheBust}`);
                
                const boardResponse = await fetch(`../data/board-data.json?v=${cacheBust}`);
                const boardData = await boardResponse.json();
                
                const board = createBoard(boardData);
                const state = createInitialState(board, boardData);
                
                const pieces = state.pieces;
                const pieceCount = Object.keys(pieces).length;
                
                if (pieceCount === 0) {
                    throw new Error('No pieces found in initial state');
                }
                
                // Check if pieces have valid coordinates
                const invalidPieces = Object.values(pieces).filter(piece => 
                    !piece.coords || piece.coords.length !== 2 || 
                    typeof piece.coords[0] !== 'number' || typeof piece.coords[1] !== 'number'
                );
                
                if (invalidPieces.length > 0) {
                    throw new Error(`${invalidPieces.length} pieces have invalid coordinates`);
                }
                
                const pieceList = Object.values(pieces).map(piece => ({
                    id: piece.id,
                    type: piece.type,
                    player: piece.player,
                    coords: piece.coords
                }));
                
                addTestResult('game-test-results', 'Piece Visibility', true, 
                    `${pieceCount} pieces found with valid coordinates`,
                    { pieceCount, pieceList });
                    
            } catch (error) {
                addTestResult('game-test-results', 'Piece Visibility', false, error.message);
            }
        };

        window.testSetupPhase = async function() {
            try {
                debugLog('Testing setup phase...');
                
                const { createInitialState, createBoard } = await import(`../core/board.js?v=${cacheBust}`);
                
                const boardResponse = await fetch(`../data/board-data.json?v=${cacheBust}`);
                const boardData = await boardResponse.json();
                
                const board = createBoard(boardData);
                const state = createInitialState(board, boardData);
                
                if (state.gamePhase !== 'setup') {
                    throw new Error(`Expected game phase 'setup', got '${state.gamePhase}'`);
                }
                
                if (state.setupTurn !== 1) {
                    throw new Error(`Expected setup turn 1, got ${state.setupTurn}`);
                }
                
                if (state.currentPlayer !== 'circles') {
                    throw new Error(`Expected current player 'circles', got '${state.currentPlayer}'`);
                }
                
                addTestResult('game-test-results', 'Setup Phase', true, 
                    `Setup phase initialized correctly. Phase: ${state.gamePhase}, Turn: ${state.setupTurn}, Player: ${state.currentPlayer}`);
                    
            } catch (error) {
                addTestResult('game-test-results', 'Setup Phase', false, error.message);
            }
        };

        window.createVisualTest = async function() {
            try {
                debugLog('Creating visual test...');
                
                const container = document.getElementById('visual-test-container');
                container.innerHTML = '<div class="test-controls"><h4>Visual Debug Controls</h4><button onclick="redrawVisualTest()">Redraw Board</button><button onclick="toggleDebugInfo()">Toggle Debug Info</button></div>';
                
                const boardResponse = await fetch(`../data/board-data.json?v=${cacheBust}`);
                const boardData = await boardResponse.json();
                
                const { createGameCanvas } = await import(`../ui/graphics.js?v=${cacheBust}`);
                
                const canvasDiv = document.createElement('div');
                canvasDiv.className = 'canvas-container';
                container.appendChild(canvasDiv);
                
                window.visualTestCanvas = createGameCanvas(canvasDiv, boardData);
                window.visualTestCanvas.drawBoard();
                
                // Add click handler for coordinate debugging
                window.visualTestCanvas.canvas.addEventListener('click', (e) => {
                    const rect = window.visualTestCanvas.canvas.getBoundingClientRect();
                    const mouseX = e.clientX - rect.left;
                    const mouseY = e.clientY - rect.top;
                    const coords = window.visualTestCanvas.getCoordinatesFromPixel(mouseX, mouseY);
                    debugLog(`Clicked coordinates: [${coords[0]}, ${coords[1]}]`);
                });
                
                addTestResult('graphics-test-results', 'Visual Test', true, 'Visual test canvas created successfully');
                
            } catch (error) {
                addTestResult('graphics-test-results', 'Visual Test', false, error.message);
            }
        };

        window.redrawVisualTest = function() {
            if (window.visualTestCanvas) {
                window.visualTestCanvas.drawBoard();
                debugLog('Visual test redrawn');
            }
        };

        window.runAllTests = async function() {
            clearAllResults();
            debugLog('🚀 Starting comprehensive test suite...');
            
            const tests = [
                testDataLoading,
                testBoardDataStructure,
                testBoardGeneration,
                testBoardDictionary,
                testGoldenConnections,
                testCanvasCreation,
                testBoardRendering,
                testIntersectionCounts,
                testGameInitialization,
                testPieceVisibility,
                testSetupPhase
            ];
            
            for (const test of tests) {
                try {
                    await test();
                    await new Promise(resolve => setTimeout(resolve, 100)); // Small delay between tests
                } catch (error) {
                    debugLog(`Test failed: ${error.message}`);
                }
            }
            
            const passed = Object.values(testResults).filter(r => r.success).length;
            const total = Object.keys(testResults).length;
            
            debugLog(`🏁 Test suite completed: ${passed}/${total} tests passed`);
            
            if (passed === total) {
                addTestResult('data-test-results', 'All Tests', true, `All ${total} tests passed! 🎉`);
            } else {
                addTestResult('data-test-results', 'All Tests', false, `${total - passed} tests failed. Check results above.`);
            }
        };

        // Auto-run tests on page load
        setTimeout(() => {
            debugLog('🔧 Test suite ready. Click "Run All Tests" to begin diagnostics.');
        }, 1000);
    </script>
</body>
</html>
